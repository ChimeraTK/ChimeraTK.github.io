<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChimeraTK-ApplicationCore: doc/spec_initialValuePropagation.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ChimeraTK-ApplicationCore
   &#160;<span id="projectnumber">master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('spec__initial_value_propagation_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">doc/spec_initialValuePropagation.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="spec__initial_value_propagation_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Technical specification: propagation of initial values {#spec_initialValuePropagation}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;======================================================</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;&gt; **DRAFT VERSION, WRITE-UP IN PROGRESS!**</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;## Introduction ##</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;This document describes how initial values are propagated from the control system persistency layer, from the devices and (if applicable) from application modules into the attached components (control system, devices and other application modules).</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;This specification goes beyond ApplicationCore. It has impact on other ChimeraTK libraries like DeviceAccess, the ControlSystemAdapter and even backends and adapter implementations.</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;## Definitions ##</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;- Initial value: The first valid value of a process variable after application start. This is a logical concept. It is to be distinguished from the (hardcoded) &quot;first value&quot; of the `ChimeraTK::ProcessArray` or any other `ChimeraTK::NDRegisterAccessor` implementation.</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;## High-level requirements ##</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;- Initial values must be available to all `ApplicationModule`s at the start of the `mainLoop()`. No call to `read()` etc. is required. This implies that the `mainLoop()` is not started until all initial values are available, including those coming from devices which might potentially be offline.</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;- Devices must receive the initial values as soon as possible after the device is opened and after the initialisation sequence is executed, but before anything else gets written to the device.</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;- The control system must receivce the initial values as soon as they are available. The initial value is merely the first value the control system receives for a particular process variable - other variables might have received an update already multiple times before the initial value is recieved.</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;- Control system variables show the `DataValidity::faulty` flag until they have received the initial value.</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;## Detailed requirements ##</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;1. All `ChimeraTK::NDRegisterAccessor` implementations (including but not limited to the `ChimeraTK::ProcessArray`) must have the `DataValidity::faulty` flag set after construction for the receiving end. This ensures, all data is marked as `faulty` as long as no sensible initial values have been propagated. The sending end must have `DataValidity::ok`, so that the first written data automatically propagates the ok state. [TBD: What about bidirectional variables?]</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;2. All `ChimeraTK::NDRegisterAccessor` implementations must have initially a `ChimeraTK::VersionNumber` constructed with a `nullptr`, which allows to check whether this variable is still at its &quot;first value&quot; or the initial value propagation already took place.</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;3. All `ApplicationModules` and similar entities (like `ThreadedFanOut` and `TriggerFanOut`), that store a `DataValidity` directly or indirectly e.g. in form af a counter, must have their internal `DataValidity` flag set to `ok` after construction.</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;4. The initial `DataValidity::faulty` flags must not be propagated actively. The first propagated data must be always `ok` and must have a valid value.</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;5. Control system variables:</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  1. Variables with the control-system-to-application direction must be written exactly once at application start by the control system adapter with their initial values from the persistency layer and the `DataValidity::ok`. This must be done before `ApplicationBase::run()` is called. [TBD: Is this last sentence a necessary restiction?]</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  2. Initial values of variables with the application-to-control-system direction are written at an undefined time after the `ApplicationBase::run()` has been called. The control system adapter must not expect any specific behaviour. Entities writing to these variables do not need to take any special precautions, they do not even need to obey the second sentence in 4. In other words: application-to-control-system variables do not have an &quot;initial value&quot; in this particular meaning.</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;6. Device variables:</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  1. Write accessors need to be written right after the device is opened and the initialisation is done.</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  2. Read accessors need to be read after 6.a. [TBD: Is this ordering even possible? It is more like a &#39;nice to have&#39; and not strictly required.]</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;7. Outputs of `ApplicationModule`s:</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  1. By default, no initial values are propagated.</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  2. Initial values can be written in `ApplicationModule::prepare()`. This fact is recorded in the variable model (`VariableNetworkNode`), see 8.b.v</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  3. Since in `ApplicationModule::prepare()` all devices are still closed, any writes to device variables at this point need to be delayed until the device is open. The actual write is hence performed by the DeviceModule.</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;8. Inputs of `ApplicationModule`s:</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  1. Initial values are read before start of `mainLoop()`.</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  2. Since not all variables have initial values (see 7.a), the variable model (`VariableNetworkNode`) needs to be checked whether an initial value is present and how it needs to be read. This dependes on the data source type (i.e. the type of the feeder of the VariableNetwork):</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    1. control system variable: blocking read</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    2. device register without trigger: non-blocking read (even if register is push-type)</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    3. device register with trigger (incl. TriggerType::pollingConsumer): blocking read</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    4. constant: non-blocking read</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    5. application: blocking read only if initial value was provided (see 7.a), otherwise no read</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;9. `ThreadedFanOut` and `TriggerFanOut` etc.</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  1. Inputs need to behave like described in 8.b</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  2. Outputs connected to devices need to obey 6.a</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  3. Outputs connected to `ApplicationModule`s will pass on the initial value, as the `ApplicationModule` will obey 8.b just like the FanOut input.</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;10. Constants:</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  1. Values are propagated before the `ApplicationModule` threads are starting.</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  2. Special treatment for constants written to devices: They need to be written after the device is opened, see 6.a</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;### Comments ###</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;- To 3.: It looks like a conflict with 1., but it is not. Due to 1., all variables will already present itself to the outside as `faulty`. 3. has an impact on the DataValidity of variables written within the module. If a module decides to write a variable even before any inputs are checked, it should be assumed that the written values are valid. Hence the internal validity must start at `ok`.</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;- To 4.: It is very important that no wrong data is transported initially. Since the &quot;first value&quot; of all process variables is always 0, this value is basically always wrong. If it gets propagated within the application, modules will process this value (usually even if `DataValidity::faulty` is set), despite the value might present an inconsistent state with other process variables. If it gets propagated to the control system, other applications might act on an again inconsistent state.</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;- To 5.: This is the responsibility of each control system adpater implementation.</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;- To 5.a: It is important that the initial values are written before `ApplicationBase::run()` to avoid race conditions if `readLatest()` might be used for the initial values (e.g. in ThreadedFanOuts). This can also be solved differently, if in all these places the same logic as in 8. is applied.</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;## Implementation ##</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;### NDRegisterAccessor implementations ###</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;- 1. must currently be implemented by each NDRegisterAccessor separately. [TBD: Instead of requiring all implementations to be changed, we could also fix this in `Application::createDeviceVariable()`, but this creates an asymetry to the `ProcessArray`...]</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;- 2. must currently be implemented by each NDRegisterAccessor separately. All accessors should already have a VersionNumber data member called `currentVersion` or similar, it simply needs to be constructed with a `nullptr` as an argument.</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;- The `UnidirectionalProcessArray` uses always a default start value of `DataValidity::ok`, but overwrites this with `DataValidity::faulty` for the receivers in the factory function `createSynchronizedProcessArray()` (both implementations, see UnidirectionalProcessArray.h).</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;### ApplicationModule ###</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;- Needs to implement 3.</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;- `getDataValidity()` returns `ok` if the `faultCounter` is 0, `faulty` otherwise</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;- Hence fault counter starts with 0.</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;### ThreadedFanOut ###</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;- Needs to implement 3.</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;- Currently just passing on the validity from the input.</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;- This is probably going to change when the correct propagation of the validity flag is implemented.</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;### ThreadedFanOut ###</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;- Needs to implement 3.</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;## Known bugs ##</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;### NDRegisterAccessor implementations ###</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;- 1. is not implemented for Device implementations (only the `UnidirectionalProcessArray` is correct at the moment).</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;- 2. is not implemented for Device implementations (only the `UnidirectionalProcessArray` is correct at the moment).</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;### ExceptionHandlingDecorator ###</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;- It waits until the device is opened, but not until after the initialisation is done.</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;### Documentation ###</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;- Documentation of ControlSystemAdapter should mention that implementations must take care about 5.</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="spec__initial_value_propagation_8md.html">spec_initialValuePropagation.md</a></li>
    <li class="footer">Generated on Fri Feb 28 2020 04:53:59 for ChimeraTK-ApplicationCore by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
