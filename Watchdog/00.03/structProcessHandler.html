<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>watchdog-server: ProcessHandler Struct Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="hzdr_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">watchdog-server
   &#160;<span id="projectnumber">@watchdog-server_VERSION@</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="structProcessHandler-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">ProcessHandler Struct Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Handler used to start and stop processes.  
 <a href="structProcessHandler.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="ProcessHandler_8h_source.html">ProcessHandler.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a8b3e2bdfd035834b7f1f24448612634e"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structProcessHandler.html#a8b3e2bdfd035834b7f1f24448612634e">ProcessHandler</a> (const std::string &amp;PIDFileName, const bool deletePIDFile, int &amp;PID, std::ostream &amp;os, const std::string &amp;name=&quot;&quot;)</td></tr>
<tr class="separator:a8b3e2bdfd035834b7f1f24448612634e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7eae2717540d1d2da5218998a00a44ec"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structProcessHandler.html#a7eae2717540d1d2da5218998a00a44ec">ProcessHandler</a> (const std::string &amp;PIDFileName, const bool deletePIDFile=false, std::ostream &amp;os=std::cout, const std::string &amp;name=&quot;&quot;)</td></tr>
<tr class="separator:a7eae2717540d1d2da5218998a00a44ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9102d9895d68907414a97d4cd4ed79cc"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structProcessHandler.html#a9102d9895d68907414a97d4cd4ed79cc">startProcess</a> (const std::string &amp;path, const std::string &amp;cmd, const std::string &amp;logfile, const std::string &amp;environment=&quot;&quot;, const bool &amp;overwriteENV=false)</td></tr>
<tr class="separator:a9102d9895d68907414a97d4cd4ed79cc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19a0020ef87b7e09c84c112a944016f6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structProcessHandler.html#a19a0020ef87b7e09c84c112a944016f6">setSigNum</a> (int sig)</td></tr>
<tr class="separator:a19a0020ef87b7e09c84c112a944016f6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0db436c44ab9d066f8ad4f925d69ab45"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structProcessHandler.html#a0db436c44ab9d066f8ad4f925d69ab45">SetLogLevel</a> (const logging::LogLevel &amp;level)</td></tr>
<tr class="separator:a0db436c44ab9d066f8ad4f925d69ab45"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace0b788dd6e9dfcc29cb4ecb085e2b5e"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ace0b788dd6e9dfcc29cb4ecb085e2b5e"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>Disconnect</b> ()</td></tr>
<tr class="separator:ace0b788dd6e9dfcc29cb4ecb085e2b5e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:ab21685e016fc2f3365665640261e939c"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structProcessHandler.html#ab21685e016fc2f3365665640261e939c">setAllFHCloseOnExec</a> ()</td></tr>
<tr class="separator:ab21685e016fc2f3365665640261e939c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4eb6afb25ee59bf5e015c465b71c40c2"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structProcessHandler.html#a4eb6afb25ee59bf5e015c465b71c40c2">setupHandler</a> ()</td></tr>
<tr class="separator:a4eb6afb25ee59bf5e015c465b71c40c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Handler used to start and stop processes. </p>
<p>Use the Handler only to start a single process. When a process is started fork + execv is used. The parent process does not know the child process and its pid. Therefore, the child creates a file that contains the PID. The parent process reads the PID from that file. The file is created in the /tmp directory of the system. In case the system reboots /tmp is cleaned and therefor it can not happen, that the PID read from the PID file is given to another process after system boot. The file is also deleted if the started process is killed using killProcess. Else the file is not deleted. If e.g. the watchdog is killed, the process that was started before by its <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> can not be terminated and could still be running. In that case the pid file indicates that. If the watchdog constructs a new <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> it will realize during construction that the PID is still present and it will check if the process is still running. If the <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> is destroyed a check is performed if a process with the stored pid is still running. If this is the case it is killed. First the process is killed using SIGINT and if that fails SIGKILL is used.</p>
<dl class="section attention"><dt>Attention</dt><dd>Use the <a class="el" href="structProcessHandler.html#a4eb6afb25ee59bf5e015c465b71c40c2">setupHandler()</a> function once to define a handler for the SIGCHLD signal! </dd></dl>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a8b3e2bdfd035834b7f1f24448612634e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ProcessHandler::ProcessHandler </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>PIDFileName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const bool&#160;</td>
          <td class="paramname"><em>deletePIDFile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int &amp;&#160;</td>
          <td class="paramname"><em>PID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::ostream &amp;&#160;</td>
          <td class="paramname"><em>os</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>name</em> = <code>&quot;&quot;</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Constructor. It is checked if a process is already running. This is done by testing if the PID file already exists and a process with the PID read from the PID file is found. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PIDFileName</td><td>the name of the PID file -&gt; will result in: PIDFileName.PID </td></tr>
    <tr><td class="paramname">os</td><td>The ostream used to send status messages and errors. </td></tr>
    <tr><td class="paramname">deletePIDFile</td><td>If true the PID file deleted directly after reading the PID. </td></tr>
    <tr><td class="paramname">name</td><td>Give a name to the <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> to distinguish between multiple handlers. It is used in the messages send by the handler. This avoids overwriting the PID in case a second <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> starts a process with the same PID file settings. But you can not check for a running process if the <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> is not terminated correctly and started again. </td></tr>
    <tr><td class="paramname">PID</td><td>The PID is set in case a running process was found. Else it is set to -1. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a7eae2717540d1d2da5218998a00a44ec"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ProcessHandler::ProcessHandler </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>PIDFileName</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const bool&#160;</td>
          <td class="paramname"><em>deletePIDFile</em> = <code>false</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::ostream &amp;&#160;</td>
          <td class="paramname"><em>os</em> = <code>std::cout</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>name</em> = <code>&quot;&quot;</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Constructor. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">PIDFileName</td><td>the name of the PID file -&gt; will result in: PIDFileName.PID </td></tr>
    <tr><td class="paramname">os</td><td>The ostream used to send status messages and errors. </td></tr>
    <tr><td class="paramname">deletePIDFile</td><td>If true the PID file deleted directly after reading the PID. </td></tr>
    <tr><td class="paramname">name</td><td>Give a name to the <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> to distinguish between multiple handlers. It is used in the messages send by the handler. This avoids overwriting the PID in case a second <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> starts a process with the same PID file settings. But you can not check for a running process if the <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a> is not terminated correctly and started again. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="ab21685e016fc2f3365665640261e939c"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ProcessHandler::setAllFHCloseOnExec </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Tell all file handles to be closed when exec is called. Therefore this should be called after forking in the child process brefore calling exec. In principle one can find out the number of open file handles by checking /proc/self/fd Here we simply set it for all file handles that are allowed by process (typically 1024). This is supposed to be easier than finding out the correct nuber of file handles conneced to the process. </p>

</div>
</div>
<a class="anchor" id="a0db436c44ab9d066f8ad4f925d69ab45"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ProcessHandler::SetLogLevel </td>
          <td>(</td>
          <td class="paramtype">const logging::LogLevel &amp;&#160;</td>
          <td class="paramname"><em>level</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Set the log level.</p>
<p>Depending on the level messages are put to the ostream. </p>

</div>
</div>
<a class="anchor" id="a19a0020ef87b7e09c84c112a944016f6"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ProcessHandler::setSigNum </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sig</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sig</td><td>Signal used to kill the process (e.g. SIGINT = 2, SIGKILL = 9) </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a4eb6afb25ee59bf5e015c465b71c40c2"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void ProcessHandler::setupHandler </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>Setup handler for SIGCHLD signals.</p>
<p>This function should be called once before using the <a class="el" href="structProcessHandler.html" title="Handler used to start and stop processes. ">ProcessHandler</a>. It is not done automatically, because if multiple handlers are used there is no need to call this function multiple times. </p>

</div>
</div>
<a class="anchor" id="a9102d9895d68907414a97d4cd4ed79cc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t ProcessHandler::startProcess </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>logfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>environment</em> = <code>&quot;&quot;</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const bool &amp;&#160;</td>
          <td class="paramname"><em>overwriteENV</em> = <code>false</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Start a process. The process is started using fork + execv. Usually the copied process will have the same process group id (GPID) as the process how calls this function. But here we set the GPID of the new process to the process id of the new process. Thus if the child process itself starts new processes they all will have the same GPID. This allows to kill all of them at the same time calling </p><div class="fragment"><div class="line">kill -PID</div></div><!-- fragment --><p> where PID is the PID of the child process. The child process creates a file that is called "PIDFileName.PID". Depending on the set pidDirectory it can happen that more than one process is started at the same time and the file would be overwritten before the PID is read from the temporary file. </p><dl class="section remark"><dt>Remarks</dt><dd>In that case use a unique string PIDFileName used for the file name!</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">path</td><td>Path where to find the cmd you are about to call. </td></tr>
    <tr><td class="paramname">cmd</td><td>CMD including command line options. </td></tr>
    <tr><td class="paramname">logfile</td><td>Name of the log file. It will be created in the path directory. If that file already exists new output will be appended. </td></tr>
    <tr><td class="paramname">environment</td><td>Set environment variables if needed (e.g. ENSHOST=localhost, PATH=/home/bin:/home/test/bin). Separate different environments using a comma. Separate different paths per environment using a colon. </td></tr>
    <tr><td class="paramname">overwriteENV</td><td>If true the environment variables are overwritten. Else they are extended. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>PID of the created process </dd></dl>
<dl class="section remark"><dt>Remarks</dt><dd>The command will not be executated in the working directory of the calling process but in the given path! </dd></dl>

</div>
</div>
<hr/>The documentation for this struct was generated from the following files:<ul>
<li>include/<a class="el" href="ProcessHandler_8h_source.html">ProcessHandler.h</a></li>
<li>src/ProcessHandler.cc</li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
