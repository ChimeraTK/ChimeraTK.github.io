<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChimeraTK-ApplicationCore: doc/spec_dataValidityPropagation.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ChimeraTK-ApplicationCore
   &#160;<span id="projectnumber">master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('spec__data_validity_propagation_8md.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">doc/spec_dataValidityPropagation.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="spec__data_validity_propagation_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Technical specification: data validity propagation {#spec_dataValidityPropagation}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;==================================================================================</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;&gt; **DRAFT VERSION, WRITE-UP IN PROGRESS!**</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;Specification version v1.0</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;1. General idea</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;---------------</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;### 1.1 Version v1.0</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;* 1.1.1 In ApplicationCore each variable has a data validiy flag attached to it. ChimeraTK::DataValidity can be &#39;ok&#39; or &#39;faulty&#39;.</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;* 1.1.2 This flag is automatically propagated: If one of the inputs of an ApplicationModule is faulty, all outputs of this module will automatically be flagged as faulty.</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;      Fan-outs might be special cases (see 2.4).</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;* 1.1.3 If a device is in error state, all variables which are read from it shall be marked as &#39;faulty&#39;. This flag is then propagated through all the modules (via 1.1.2) so it shows up in the control system.</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;* 1.1.4 The user has the possibility to query the data validity of the module</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;* 1.1.5 The user has the possibility to set the data validity of the module to &#39;faulty&#39;. However, the user cannot actively set the module to &#39;ok&#39; if one of the inputs is &#39;faulty&#39;.</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;* 1.1.6 The user can decide to flag individual outputs as bad. However, the user cannot actively set an output to &#39;ok&#39; if the data validity of the module is &#39;faulty&#39; (to be more precise: if the validity of the corresponding  DataFaultCounter is faulty).</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;* 1.1.7 The user can get the data validity flag of individual inputs and take special actions.</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;2. Technical implementation</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;---------------------------</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;### 2.1 MetaDataPropagatingRegisterDecorator (*)</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;* 2.1.1 Each input and each output of a module (or fan out) is decorated with a ChimeraTK::MetaDataPropagatingRegisterDecorator.</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;* 2.1.2 The decorator knows about the DataFaultCounter to which it is associated.</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;* 2.1.3 **read:** For each read operation it checks the incoming data validity and informs the associated ChimeraTK::DataFaultCounter about the status.</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;* 2.1.5 **write:** When writing, the decorator is checking the validity flags of the DataFaultCounter and the individual flag of the output. Only if both are &#39;ok&#39; the output validity is &#39;ok&#39;, otherwise the outgoing data is send as &#39;faulty&#39;.</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;### 2.2 DataFaultCounter</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;* 2.2.1 A ChimeraTK::DataFaultCounter is assciated with several inputs and outputs (usually all inputs and outsput of a module, see section 2.3 about ApplicationModules).</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;* 2.2.2 It has an internal counter variable to keep track how many inputs have reported a data fault.</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;* 2.2.3 The overall data validity is only &#39;ok&#39; if the counter is zero (all inputs have validity &#39;ok), otherwise the overall data validity is &#39;faulty&#39;.</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;### 2.3 ApplicationModule</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;* 2.3.1 Each ApplicationModule has one DataFaultCounter.</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;* 2.3.2 All inputs and output are connected to it.</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;* 2.3.3 The main loop of the module usualy does not care about data validity. If any input is invalid, all outputs are automatically invalid. The loop just runs through normaly, even if an inputs has invalid data. (*)</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;* 2.3.4 Inside the ApplicationModule main loop the module&#39;s DataFaultCounter is accessible. The user can call increment and decrement it, but has to be careful to do this in pairs. The more common use case will be to query the module&#39;s data validity.</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;### 2.4 TriggerFanOut</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;The TriggerFanOut is special in the sense that it does not compute anything, but reads multiple independent poll-type inputs when a trigger arrived, and pushes them out. In contrast to an ApplicationModule or one of the data fan-outs, their data validities are not connected. The trigger conceptually has data type &#39;void&#39;, so it cannot be invalid.</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;* 2.4.1 The TriggerFanOut instantiates one DataFaultCounter for each input variable.</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;* 2.4.2 The connection code associates the input and all corresponding outputs to the correct DataFaultCounter.</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;### 2.5 Interaction with exception handling</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;See @ref exceptionHandlingDesign.</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;* 2.5.1 Like the MetaDataPropagatingRegisterDecorator, also the ExceptionHandlingDecorators of the module inputs are associated with the DataFaultCounter.</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;* 2.5.2 If a device accessor throws an exception, the ExceptionHandlingDecorator also increases the data fault counter, and decreases it once the device is available again.</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;* 2.5.3 The first failing read returns with the old data and the &#39;faulty&#39; flag. Like this the flag is propagates to the outputs. Only further reads might block.</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;### Comments:</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;* to 2.1 The MetaDataPropagatingRegisterDecorator also propagates the version number, not only the data validity flag. Hence it&#39;s not called DataValidityPropagatingRegisterDecorator.</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;* to 2.3.3 If there would be some outputs which are still valid if a particular input is faulty it means that they are not connected to that input. This usualy is an indicator that the module is doing unrelated things and should be split.</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;* to 2.3.3 A change of the data validity in the DataFaultCounter does not automatically change the validity on all outputs. A module might not always write all of its outputs. If the DataFaultCounter reports &#39;faulty&#39;, those outputs which are not written stay valid. This is correct because their calculation was not affected by the faulty data yet. And if an output which has faulty data is not updated when the data validity goes back to &#39;ok&#39; it also stays &#39;faulty&#39;, which is correct as well.</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;3. Implementation details</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;-------------------------</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;* 3.1 The DataFaultCounter is a helper class around the counter variable. It facilitates instantiation and evaluation of the counter.</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;* 3.2 The decorators which manipulate the data fault counter are responsible for counting up and down in pairs, such that the counter goes back to 0 if all data is ok, and never becomes negative.</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;* 3.3 To 2.1.2 and 2.2.1: Associated means that the MetaDataPropagatingRegisterDecorator or ExceptionHandlingDecorator gets a pointer to the DataFaultCounter. It does not own it. As the calling code of the decorator is executed in the main loop of the module or fan-out which owns the DataFaultCounter, it should be safe to shut down the application.</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;* 3.4 Interface of the DataFaultCounter (implements 2.2)</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    * 3.4.1 The counter variable itself is protected. I is increased and decreased through increment() and decrement() functions.</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    * 3.4.2 The decrement function has an assertions that the counter does not become negative (or &quot;underflow&quot; because it probably is unsigned). This simplifies debugging in case the calling code does not execute the increment and decrement in pairs.</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    * 3.4.3 A conveninece function getDataValidity() checks whether the counter is 0 and returns &#39;ok&#39; or &#39;faulty&#39; accordingly. This is just to avoid the if-statement and picking the right return value in all using code.</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    * 3.4.4 When instantiated, the counter starts at 0. If associated objects (like the ExceptionHandlingDecorators) are faulty at start it is their responsibility to increment the counter.</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;4. Known issues</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;---------------</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;* 4.1 There is no DataFaultCounter object (2.2) at the moment. The ApplicationModule itself holds the counter variable and implements the increase, decrease and getDataValidity functions. This prevents 2.4 from being implemented properly.</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;* 4.2 The ThreadedFanOut does not propagate the data validity</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;* 4.3 The ConsumingFanOut does not propagate the data validity</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;* 4.4 The TriggerFanOut does not propagate data validity (not even the way an ApplicationModule does)</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;### Comments</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;* To 4.1.2: The alternative implementation to add a data validity flag to the write() function is not a good solution because it does not work with writeAll().</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="spec__data_validity_propagation_8md.html">spec_dataValidityPropagation.md</a></li>
    <li class="footer">Generated on Sat Apr 18 2020 03:53:33 for ChimeraTK-ApplicationCore by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
