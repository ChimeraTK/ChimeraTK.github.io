<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChimeraTK-ApplicationCore: Technical specification: propagation of initial values</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ChimeraTK-ApplicationCore
   &#160;<span id="projectnumber">master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('spec_initial_value_propagation.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Technical specification: propagation of initial values </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><blockquote class="doxtable">
<p><b>DRAFT VERSION, WRITE-UP IN PROGRESS!</b> </p>
</blockquote>
<h2>Introduction</h2>
<p>This document describes how initial values are propagated from the control system persistency layer, from the devices and (if applicable) from application modules into the attached components (control system, devices and other application modules).</p>
<p>This specification goes beyond ApplicationCore. It has impact on other <a class="el" href="namespace_chimera_t_k.html" title="Generic modules for status monitoring. ">ChimeraTK</a> libraries like DeviceAccess, the ControlSystemAdapter and even backends and adapter implementations.</p>
<h2>Definitions</h2>
<ul>
<li>Initial value: The first valid value of a process variable after application start. This is a logical concept. It is to be distinguished from the (hardcoded) "first value" of the <code>ChimeraTK::ProcessArray</code> or any other <code>ChimeraTK::NDRegisterAccessor</code> implementation.</li>
</ul>
<h2>High-level requirements</h2>
<ul>
<li>Initial values must be available to all <code>ApplicationModule</code>s at the start of the <code>mainLoop()</code>. No call to <code>read()</code> etc. is required. This implies that the <code>mainLoop()</code> is not started until all initial are available, including those coming from devices which might potentially be offline.</li>
<li>Devices must receive the initial values as soon as possible after the device is opened and after the initialisation sequence is executed, but before anything else gets written to the device.</li>
<li>The control system must receivce the initial values as soon as they are available. The initial value is merely the first value the control system receives for a particular process variable - other variables might have received an update already multiple times before the initial value is recieved.</li>
<li>Control system variables show the <code>DataValidity::faulty</code> flag until they have received the initial value.</li>
</ul>
<h2>Detailed requirements</h2>
<ol type="1">
<li>All <code>ChimeraTK::NDRegisterAccessor</code> implementations (including but not limited to the <code>ChimeraTK::ProcessArray</code>) must have the <code>DataValidity::faulty</code> flag set after construction. This ensures, all data is marked as <code>faulty</code> as long as no sensible initial values have been propagated.</li>
<li>All <code>ChimeraTK::NDRegisterAccessor</code> implementations must have initially a <code>ChimeraTK::VersionNumber</code> constructed with a <code>nullptr</code>, which allows to check whether this variable is still at its "first value" or the initial value propagation already took place.</li>
<li>All <code>ApplicationModules</code> and similar entities (like <code>ThreadedFanOut</code> and <code>TriggerFanOut</code>), that store a <code>DataValidity</code> directly or indirectly e.g. in form af a counter, must have their internal <code>DataValidity</code> flag set to <code>faulty</code> after construction. [TBD: What does that mean in case of a counter?]</li>
<li>The initial <code>DataValidity::faulty</code> flags must not be propagated actively. The first propagated data must be always <code>ok</code> and must have a valid value.</li>
<li>Control system variables:<ol type="a">
<li>Variables with the control-system-to-application direction must be written exactly once at application start by the control system adapter with their initial values from the persistency layer and the <code>DataValidity::ok</code>. This must be done before <code>ApplicationBase::run()</code> is called. [TBD: Is this last sentence a necessary restiction?]</li>
<li>Initial values of variables with the application-to-control-system direction are written at an undefined time after the <code>ApplicationBase::run()</code> has been called. The control system adapter must not expect any specific behaviour.</li>
</ol>
</li>
<li>Device variables:<ol type="a">
<li>Write accessors need to be written right after the device is opened and the initialisation is done.</li>
<li>Read accessors need to be read after 6.a. [TBD: Is this ordering even possible? It is more like a 'nice to have' and not strictly required.]</li>
</ol>
</li>
<li>Outputs of <code>ApplicationModule</code>s:<ol type="a">
<li>By default, no initial values are propagated.</li>
<li>Initial values can be written in <code>ApplicationModule::prepare()</code>.</li>
</ol>
</li>
<li>Inputs of <code>ApplicationModule</code>s:<ol type="a">
<li>Initial values are read before start of <code>mainLoop()</code>.</li>
<li>Since not all variables have initial values (see 7.a), the variable model (<code>VariableNetworkNode</code>) needs to be checked whether an initial value is present and how it needs to be read. This dependes on the data source type:<ol type="i">
<li>control system variable: blocking read</li>
<li>device register without trigger: non-blocking read (even if register is push-type)</li>
<li>device register with trigger (incl. TriggerType::pollingConsumer): blocking read</li>
<li>constant: non-blocking read</li>
<li>application: blocking read only if initial value was provided (see 7.a), otherwise no read</li>
</ol>
</li>
</ol>
</li>
<li>Constants:<ol type="a">
<li>Values are propagated before the <code>ApplicationModule</code> threads are starting.</li>
<li>Special treatment for constants written to devices: They need to be written after the device is opened, see 6.a</li>
</ol>
</li>
</ol>
<h2>Implementation</h2>
<h2>Known bugs</h2>
<h3>ExceptionHandlingDecorator</h3>
<ul>
<li>It waits until the device is opened, but not until after the initialisation is done. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">index</a></li>
    <li class="footer">Generated on Thu Feb 27 2020 04:54:14 for ChimeraTK-ApplicationCore by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
