<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChimeraTK-ApplicationCore: Exception Handling Design</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ChimeraTK-ApplicationCore
   &#160;<span id="projectnumber">master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('exception_handling_design.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Exception Handling Design </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="gen_idea"></a>
General Idea</h1>
<p>Exceptions must be handled by ApplicationCore in a way that the application developer does not have to care much about it.</p>
<p>In case of a ChimeraTK::runtime_error exception the framework must catch the expection and report it to the DeviceModule. The DeviceModule should handle this exception and preiodically tries to open the device. As there could many devices make sure only the faulty device is blocked. Even if a device is faulty it should not block the server from starting.</p>
<p>Once in error state, set the DataValidity flag for that module to faulty and propogate it appropriately. After the exception is cleared and operation returns without a data fault flag, set DataValidity flag to ok. Furthermore, the device must be reinitialised automatically and also recover the values of process variables as the device might have rebooted and the variables have been re-set.</p>
<p><b>1. Genesis</b></p>
<ul>
<li>a. When <a class="el" href="class_chimera_t_k_1_1_device_module.html" title="Implementes access to a ChimeraTK::Device. ">ChimeraTK::DeviceModule</a> is created it should be registered with <a class="el" href="class_chimera_t_k_1_1_application.html">ChimeraTK::Application</a> by adding to a list in <a class="el" href="class_chimera_t_k_1_1_application.html#a8004bc7d4305468a5497e278f2af7203">ChimeraTK::Application::registerDeviceModule()</a>.</li>
<li>b. An initailisation handler can be added to the device through constructor. Initialisation handlers are callback function which will be executed when a device is opened for the first time and after a device recovers from an exception.</li>
<li>c. Initial values must be correctly propogated after a device is opened. See <a href="spec_initialValuePropagation.html">spec_initialValuePropagation</a>.</li>
<li>d. Class <a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a> facilitates ChimeraTK::NDRegisterAccessor in case of exception.</li>
<li>e. An <a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a> is placed around all ChimeraTK::NDRegisterAccessors connected to a device for <a class="el" href="class_chimera_t_k_1_1_application_module.html">ChimeraTK::ApplicationModule</a> and <a class="el" href="class_chimera_t_k_1_1_threaded_fan_out.html" title="FanOut implementation with an internal thread which waits for new data which is read from the given f...">ChimeraTK::ThreadedFanOut</a> except initial value and recovery accesors.</li>
<li>f. <a class="el" href="class_chimera_t_k_1_1_trigger_fan_out.html" title="InternalModule which waits for a trigger, then reads a number of variables and distributes each of th...">ChimeraTK::TriggerFanOut</a> is using a ChimeraTK::TransferGroup which bypass the functionalitly of <a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a> hence it has to impelment the exception handling itself.</li>
<li>g. Recovery accessor is added for device register when it is obtianed. These recovery accessors are used to correctly set the values of variables when the device is opened for the first time and after a device is recovered from an exception.</li>
<li>h. setOnwer() is used to set the <a class="el" href="class_chimera_t_k_1_1_application_module.html">ChimeraTK::ApplicationModule</a> or <a class="el" href="class_chimera_t_k_1_1_threaded_fan_out.html" title="FanOut implementation with an internal thread which waits for new data which is read from the given f...">ChimeraTK::ThreadedFanOut</a> as owner of the (feeding) device which is decorated with an <a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a>.</li>
<li>i. Write should not block in case of an exception for of ThreadedFanOut / TriggerFanOut.</li>
<li>j. <a class="el" href="class_chimera_t_k_1_1_application_module.html">ChimeraTK::ApplicationModule</a> should provide a writeDespiteError() function so that even in case of exception write should return. [TBD: name of the function]</li>
</ul>
<p><b>1.1. Definitions </b></p><ul>
<li>a. writeAfterOpen is a list of TransferElements used for initial value propogation.</li>
<li>b. writeAfterRecovery is a list of TransferElements used after recovery.</li>
</ul>
<p><b>2. The Flow</b></p>
<ul>
<li>2.1. Application always starts with all devices as closed and intial value for deviceError.status is set to 1 (in <a class="el" href="class_chimera_t_k_1_1_device_module.html#a2d094fb10f12c3d89b2088023c169b7e" title="Prepare the execution of the module. ">ChimeraTK::DeviceModule::prepare</a>).</li>
<li>2.2. Until the 2.4 is done (2.4.3), all the read and writes to this device done through ExceptionHandlingDecorator will be blocked.</li>
<li>2.3. DeviceModule::handleException() tries to open the device in a separate asynchronous thread. (This thread is responsible for (try) opening of the device for the first time and (try) re-opening of the device in case of an exception.)</li>
<li>2.4. Device is opened successfully for the first time.<ul>
<li>2.4.1. Device is initailised by iterating initialisationHandlers list. If there is an exception go back to 2.3.</li>
<li>2.4.2. The pending write operations, stored in writeAfterOpen, waiting for device to be opened are written. If there is an exception go back to 2.3.</li>
<li>2.4.3. deviceError.status is set to 0.</li>
</ul>
</li>
<li>2.5. When a read / write operation on device (1.e and 1.f ) causes a ChimeraTK::runtime_error exception, the exception is caught.<ul>
<li>2.5.1. Inside ExceptionHandlingDecorator / TriggerFanOut,<ul>
<li>2.5.1.1. If read operation:<ul>
<li>2.5.1.1.1 The dataValidity of the owner is set to faulty using incrementDataInvalidCounter(). [TBD: name]</li>
</ul>
</li>
<li>2.5.1.2. The error is reported to the DeviceModule via <a class="el" href="class_chimera_t_k_1_1_device_module.html#a866cf974d4a178d389753536be5a88db" title="Use this function to report an exception. ">ChimeraTK::DeviceModule::reportException()</a>.</li>
<li>2.5.1.3. Calling operation :<ul>
<li>write : blocks until the device is recovered,</li>
<li>read : For the first blocking read call returns with invalid data and then remembers that it is in an exception state. The second call will finally block.</li>
<li>readNonBlocking / readLatest: will always return with data invalid flag.</li>
</ul>
</li>
</ul>
</li>
<li>2.5.3. The exception is received by DeviceModule::handleException() which has been launched in a separate asynchronous thread.<ul>
<li>2.5.3.1. deviceError.status will be set to 1.</li>
<li>2.5.3.2. Try re-opening the device until successful. (Although the function is called Open, to reach this point a device must have been opened at least once before, hence re-open.)</li>
<li>2.5.3.3. Device is re-opened successfully and isFunctional() returns true.</li>
<li>2.5.3.4. Device is reinitalisied through initialisationHandlers. If exception is thrown go back to 2.5.3.2 (It won't be reported again.)</li>
<li>2.5.3.5. Process variables are written again using the list of TransferElements in writeAfterRecovery. Recovery accessor do not write if the register is never written before. If exception is thrown go back to 2.5.3.2. (It won't be reported again.)</li>
<li>2.5.3.6. All threads that were blocked after calling DeviceModule::reportException() for this device are notified. (from 2.5.1.3)</li>
<li>2.5.3.7. deviceError.status is set to 0.</li>
</ul>
</li>
<li>2.5.4. Continue inside ExceptionHandlingDecorator / TriggerFanOut,<ul>
<li>2.5.4.1. If read operation:<ul>
<li>2.5.4.1.1 The dataValidity of the owner is set to ok using decrementExceptionFaultCounter(). [TBD: name]</li>
<li>2.5.4.1.2. The owner will then write all outputs with ChimeraTK::DataValidity::ok. This write operation must not block even in case of exceptions, but exceptions are reported to the corresponding DeviceModule, and the flag is always written to the corresponding recoveryAccessor. [TBD: Name of new write function.]</li>
</ul>
</li>
<li>2.5.4.2. The original read/write operation is executed. If an exception occurs go back to 2.5.1.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><b>3. Known Bugs.</b></p>
<ul>
<li>Step 2.1 The intial value of deviceError is not set to 1.</li>
<li>Step 2.2. is not correctly fulfilled as we are only waiting for device to be opened and don't wait for it to be correctly initialised.</li>
<li>Step 2.4.3. is currently being set before initialisationHandlers and writeAfterOpen.</li>
<li>Step 2.5.3.7. is currently being set before initialisationHandlers and writeRecoveryOpen.</li>
<li>Check the comment in Device.h about writeAfterOpen(). 'This is used to write constant feeders to the device.'</li>
<li>Check the documentation of DataValidity. ...'Note that if the data is distributed through a triggered FanOut....'</li>
</ul>
<p><b>Implmentation Details</b></p>
<p><b>4. Exception handling and reporting mechanism to the device module (DeviceModule).</b></p>
<p>Description.</p>
<p>These variables are automatically connected to the control systen in this format</p><ul>
<li>/Devices/{AliasName}/message</li>
<li>/Devices/{AliasName}/status</li>
</ul>
<p>Add a thread safe function <a class="el" href="class_chimera_t_k_1_1_device_module.html#a866cf974d4a178d389753536be5a88db" title="Use this function to report an exception. ">ChimeraTK::DeviceModule::reportException()</a>. A user/application can report an exception by calling reportException of DeviceModule with an exception string. The reportException packs the exception in a queue and the blocks the thread. This queue is processed by an internal function handleException which updates the DeviceError variables (status=1 and message="YourExceptionString") and tries to open the device. Once device can be opened the DeviceError variables are updated (status=0 and message="") and blocking threads are notified to continue. It must be noted that whatever operation which lead to exception e.g., read or write, should be repeated after the exception is handled.</p>
<p>Implementation.</p><ul>
<li><a class="el" href="class_chimera_t_k_1_1_device_module.html" title="Implementes access to a ChimeraTK::Device. ">ChimeraTK::DeviceModule</a></li>
</ul>
<p><b>5. Catch ChimeraTK::runtime_error exceptions.</b></p>
<p>Description.</p>
<p>For a device with it's deviceError.status = 0 (see 2.4.3), catch all the ChimeraTK::runtime_error exceptions that could be thrown in read and write operations and feed the error state into the DeviceModule through the function <a class="el" href="class_chimera_t_k_1_1_device_module.html#a866cf974d4a178d389753536be5a88db" title="Use this function to report an exception. ">ChimeraTK::DeviceModule::reportException()</a>. Retry the failed operation after reportException() returns.</p>
<p>For a device that has been opened for the first time but has not reached 2.4.3 i.e., it's deviceError.status != 0, and it throws a ChimeraTK::runtime_error exception see 2.3.</p>
<p>Implementation.</p><ul>
<li>Exceptions are caught as explained in 1.e and 1.f.</li>
<li>ChimeraTK::NDRegisterAccessors</li>
<li><a class="el" href="class_chimera_t_k_1_1_application.html">ChimeraTK::Application</a></li>
</ul>
<p><b>6. Faulty device should not block any other device.</b></p>
<p>Description.</p>
<p>Each <a class="el" href="class_chimera_t_k_1_1_trigger_fan_out.html" title="InternalModule which waits for a trigger, then reads a number of variables and distributes each of th...">ChimeraTK::TriggerFanOut</a> deals with several variable networks at the same time, which are triggered by the same trigger. Each variable network has its own feeder and one or more consumers. The trigger itself is a variable network, too. One consumer per <a class="el" href="class_chimera_t_k_1_1_trigger_fan_out.html" title="InternalModule which waits for a trigger, then reads a number of variables and distributes each of th...">ChimeraTK::TriggerFanOut</a> is required. Implementation.</p>
<ul>
<li><a class="el" href="class_chimera_t_k_1_1_application.html#ad431c8d3f6f19a593a37b13c5f7cefe8" title="UserType-dependent part of makeConnectionsForNetwork() ">ChimeraTK::Application::typedMakeConnection()</a></li>
</ul>
<p><b>7. The server must always start even if a device is in error state.</b></p>
<p>Description.</p>
<p>To make sure that the server should always start, the initial opening of the device should take place in the <a class="el" href="class_chimera_t_k_1_1_device_module.html#ab388c8a6e152379643f96c8fb945d3a3" title="This functions tries to open the device and set the deviceError. ">ChimeraTK::DeviceModule::handleException()</a>, which has the exception handling loop so that device can go to the error state right at the beginning and the server can start despite not all its devices are available.</p>
<p>Implementation.</p>
<ul>
<li><a class="el" href="class_chimera_t_k_1_1_device_module.html#ab388c8a6e152379643f96c8fb945d3a3" title="This functions tries to open the device and set the deviceError. ">ChimeraTK::DeviceModule::handleException()</a></li>
</ul>
<p><b>8. Propogate error flag</b></p>
<p>Description.</p>
<p>See 2.5.1.</p>
<p>For initial error propogation see <a href="spec_initialValuePropagation.html">spec_initialValuePropagation</a>.</p>
<p>Implmentation.</p><ul>
<li><a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a></li>
<li><a class="el" href="class_chimera_t_k_1_1_trigger_fan_out.html" title="InternalModule which waits for a trigger, then reads a number of variables and distributes each of th...">ChimeraTK::TriggerFanOut</a></li>
</ul>
<p><b>9. Initialise the device</b></p>
<p>Description.</p>
<p>The device should be automatically initialised when opened for first time (2.4.1) and automatically re-initialised after recovery (2.5.3.4).</p>
<p>Implementation.</p>
<p>A list of DeviceModule std::function is added. InitialisationHandlers can be added through construtor and addInitialisationHandler() function. When the device recovers all the initialisationHandlers in the list are executed.</p><ul>
<li><a class="el" href="class_chimera_t_k_1_1_device_module.html" title="Implementes access to a ChimeraTK::Device. ">ChimeraTK::DeviceModule</a></li>
<li><a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a></li>
</ul>
<p><b>10. Recover process variables after exception.</b></p>
<p>Background.</p>
<p>After a device has failed and recovered, it might have re-booted and lost the values of the process variables that live in the server and are written to the device. Hence these values have to be re-written after the device has recovered.</p>
<p>Description.</p>
<p>Create a copy of accessor when writing the data to the device and use this to recover the values when the device is available again. Recovery accessor do not write if the register is never written before (2.5.3.5.).</p>
<p>Implementation.</p>
<ul>
<li><a class="el" href="class_chimera_t_k_1_1_device_module.html" title="Implementes access to a ChimeraTK::Device. ">ChimeraTK::DeviceModule</a></li>
<li><a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a></li>
<li>A list of ChimeraTK::TransferElements is created as <a class="el" href="class_chimera_t_k_1_1_device_module.html#accf9d83766a0503e4118aeeae0aec36e" title="List of TransferElements to be written after the device has been recovered. ">ChimeraTK::DeviceModule::writeRecoveryOpen</a> which is populated in function <a class="el" href="class_chimera_t_k_1_1_device_module.html#a20002fcf65d413b83e16fb2d578680d6" title="Add a TransferElement to the list DeviceModule::writeRecoveryOpen. ">ChimeraTK::DeviceModule::addRecoveryAccessor()</a>. <a class="el" href="class_chimera_t_k_1_1_exception_handling_decorator.html" title="Decorator of the NDRegisterAccessor which facilitates tests of the application. ">ChimeraTK::ExceptionHandlingDecorator</a> is extended by adding second accessor to the same register as the target accessor it is decorating. <em> Data is copied in doPreWrite(). [TBD: Do we want this behaviour?]</em> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">index</a></li>
    <li class="footer">Generated on Wed Mar 4 2020 04:53:42 for ChimeraTK-ApplicationCore by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
